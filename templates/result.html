{% extends "base.html" %} {% set title = "Result" %} {% block content %}

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
  <section class="lg:col-span-2">
    <div class="bg-white rounded-2xl shadow-soft border border-slate-200 p-6">
      <h1 class="text-2xl font-semibold tracking-tight">Hasil Prediksi</h1>
      <p class="mt-2 text-slate-600 break-all">
        <span class="font-medium">URL:</span> {{ url_input }}
      </p>

      <div class="mt-3">
        <span
          class="inline-flex items-center rounded-full bg-slate-100 px-3 py-1 text-xs font-semibold text-slate-700 ring-1 ring-inset ring-slate-200"
        >
          Mode: {{ pred.mode }}
        </span>
      </div>

      <!-- Visualisasi Probabilitas -->
      <div
        class="mt-6 bg-gradient-to-br from-slate-50 to-slate-100 rounded-2xl border border-slate-200 p-6"
      >
        <h2 class="text-base font-semibold mb-4">
          Visualisasi Probabilitas Phishing
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="flex items-center justify-center">
            <canvas id="probabilityGauge" width="250" height="250"></canvas>
          </div>
          <div class="flex flex-col justify-center space-y-3">
            <div class="rounded-xl bg-white border border-slate-200 p-4">
              <div class="text-xs text-slate-500">Skor Risiko</div>
              <div class="mt-2 flex items-center gap-3">
                <div
                  class="flex-1 bg-slate-200 rounded-full h-3 overflow-hidden"
                >
                  <div
                    class="h-full rounded-full transition-all duration-500 {{ 'bg-red-500' if pred.prob_phishing >= 0.8 else ('bg-amber-500' if pred.prob_phishing >= 0.5 else 'bg-emerald-500') }}"
                    style="width: {{ (pred.prob_phishing * 100)|int }}%"
                  ></div>
                </div>
                <span class="text-sm font-bold"
                  >{{ '%.1f'|format(pred.prob_phishing * 100) }}%</span
                >
              </div>
            </div>
            <div class="rounded-xl bg-white border border-slate-200 p-4">
              <div class="text-xs text-slate-500">Threshold Model</div>
              <div class="mt-1 text-2xl font-bold text-indigo-600">
                {{ '%.2f'|format(pred.threshold) }}
              </div>
            </div>
            <div class="rounded-xl bg-white border border-slate-200 p-4">
              <div class="text-xs text-slate-500">Tingkat Risiko</div>
              <div class="mt-1">
                <span
                  class="inline-flex items-center rounded-full px-3 py-1 text-sm font-semibold
                  {{ 'bg-red-100 text-red-700 ring-1 ring-red-200' if pred.risk_level == 'High' else
                     ('bg-amber-100 text-amber-700 ring-1 ring-amber-200' if pred.risk_level == 'Medium' else
                      'bg-emerald-100 text-emerald-700 ring-1 ring-emerald-200') }}"
                >
                  {{ pred.risk_level }}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="mt-6 grid grid-cols-1 sm:grid-cols-3 gap-4">
        <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4">
          <div class="text-xs text-slate-500">Prediksi</div>
          <div
            class="mt-1 text-lg font-semibold {{ 'text-red-600' if pred.pred_label=='phishing' else 'text-emerald-600' }}"
          >
            {{ pred.pred_label|upper }}
          </div>
          <div class="mt-1 text-xs text-slate-500">
            Risk: {{ pred.risk_level }}
          </div>
        </div>

        <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4">
          <div class="text-xs text-slate-500">Probabilitas phishing</div>
          <div class="mt-1 text-lg font-semibold">
            {{ '%.4f'|format(pred.prob_phishing) }}
          </div>
          <div class="mt-1 text-xs text-slate-500">
            Threshold: {{ '%.2f'|format(pred.threshold) }}
          </div>
        </div>

        <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4">
          <div class="text-xs text-slate-500">
            Label dataset (jika mode full-feature)
          </div>
          <div class="mt-1 text-lg font-semibold">
            {{ true_label|upper if true_label else "—" }}
          </div>
          <div class="mt-1 text-xs text-slate-500">
            0=phishing, 1=legitimate
          </div>
        </div>
      </div>

      {% if suggestions %}
      <div class="mt-6 rounded-xl border border-amber-200 bg-amber-50 p-4">
        <h2 class="text-sm font-semibold text-amber-900">Catatan</h2>
        <p class="mt-1 text-sm text-amber-900">
          URL ini tidak ditemukan di dataset, jadi sistem memakai mode
          <span class="font-semibold">url-only</span>. Berikut contoh URL di
          dataset yang mengandung substring mirip:
        </p>
        <ul class="mt-2 text-sm text-amber-900 list-disc pl-5 space-y-1">
          {% for s in suggestions %}
          <li class="break-all">{{ s }}</li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}

      <div class="mt-6 flex flex-wrap gap-3">
        <a
          href="{{ url_for('index') }}"
          class="rounded-xl bg-indigo-600 px-5 py-3 text-sm font-semibold text-white shadow-soft hover:bg-indigo-700"
        >
          Cek URL lain
        </a>
        <a
          href="{{ url_for('dataset') }}"
          class="rounded-xl border border-slate-300 bg-white px-5 py-3 text-sm font-semibold text-slate-800 hover:bg-slate-50"
        >
          Browse dataset
        </a>
      </div>
    </div>

    {% if feature_preview %}
    <div
      class="mt-6 bg-white rounded-2xl shadow-soft border border-slate-200 p-6"
    >
      <h2 class="text-base font-semibold">Preview fitur (Full-feature)</h2>
      <p class="mt-1 text-sm text-slate-600">
        Menampilkan 12 fitur pertama yang digunakan model full-feature.
      </p>

      <!-- Visualisasi Bar Chart -->
      <div class="mt-6 bg-slate-50 rounded-xl p-4">
        <canvas id="featuresChart" height="80"></canvas>
      </div>

      <div class="mt-4 overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="text-left text-slate-500">
            <tr>
              <th class="py-2 pr-6">Fitur</th>
              <th class="py-2">Nilai</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-100">
            {% for k, v in feature_preview %}
            <tr>
              <td class="py-2 pr-6 font-medium text-slate-800">{{ k }}</td>
              <td class="py-2 text-slate-700 break-all">{{ v }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% endif %} {% if urlonly_preview %}
    <div
      class="mt-6 bg-white rounded-2xl shadow-soft border border-slate-200 p-6"
    >
      <h2 class="text-base font-semibold">
        Preview fitur (URL-only + kebaruan)
      </h2>
      <p class="mt-1 text-sm text-slate-600">
        Menampilkan 16 fitur pertama yang dihitung dari string URL.
      </p>

      <!-- Visualisasi Bar Chart untuk URL-only -->
      <div class="mt-6 bg-slate-50 rounded-xl p-4">
        <canvas id="urlFeaturesChart" height="80"></canvas>
      </div>

      <div class="mt-4 overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="text-left text-slate-500">
            <tr>
              <th class="py-2 pr-6">Fitur</th>
              <th class="py-2">Nilai</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-100">
            {% for k, v in urlonly_preview %}
            <tr>
              <td class="py-2 pr-6 font-medium text-slate-800">{{ k }}</td>
              <td class="py-2 text-slate-700 break-all">{{ v }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% endif %}
  </section>

  <aside>
    <div class="bg-white rounded-2xl shadow-soft border border-slate-200 p-6">
      <h2 class="text-base font-semibold">Interpretasi</h2>
      <p class="mt-2 text-sm text-slate-600">
        Probabilitas menunjukkan seberapa kuat model menganggap URL termasuk
        phishing berdasarkan pola fitur. Mode
        <span class="font-medium">full-feature</span> umumnya lebih kaya fitur,
        sedangkan <span class="font-medium">url-only</span>
        lebih praktis untuk URL eksternal.
      </p>

      <div class="mt-6">
        <a
          href="{{ url_for('model') }}"
          class="text-sm font-semibold text-indigo-700 hover:text-indigo-800"
        >
          Lihat status artifacts →
        </a>
      </div>
    </div>
  </aside>
</div>

<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
  // Data dari Flask
  const probPhishing = {{ pred.prob_phishing }};
  const threshold = {{ pred.threshold }};
  const predLabel = "{{ pred.pred_label }}";
  const riskLevel = "{{ pred.risk_level }}";

  // Warna berdasarkan risiko
  const getRiskColor = (prob) => {
    if (prob >= 0.8) return { primary: '#ef4444', light: '#fee2e2', accent: '#dc2626' };
    if (prob >= 0.5) return { primary: '#f59e0b', light: '#fef3c7', accent: '#d97706' };
    return { primary: '#10b981', light: '#d1fae5', accent: '#059669' };
  };

  const colors = getRiskColor(probPhishing);

  // 1. Gauge Chart untuk Probabilitas
  const gaugeCtx = document.getElementById('probabilityGauge');
  if (gaugeCtx) {
    const gaugeData = {
      labels: ['Phishing', 'Legitimate'],
      datasets: [{
        data: [probPhishing * 100, (1 - probPhishing) * 100],
        backgroundColor: [colors.primary, '#e2e8f0'],
        borderWidth: 0,
        circumference: 180,
        rotation: 270,
      }]
    };

    new Chart(gaugeCtx, {
      type: 'doughnut',
      data: gaugeData,
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: function(context) {
                return context.label + ': ' + context.parsed.toFixed(2) + '%';
              }
            }
          }
        },
        cutout: '75%',
      },
      plugins: [{
        id: 'gaugeText',
        afterDraw: (chart) => {
          const { ctx, chartArea: { width, height } } = chart;
          ctx.save();
          const centerX = width / 2;
          const centerY = height * 0.75;

          // Probabilitas
          ctx.font = 'bold 32px sans-serif';
          ctx.fillStyle = colors.primary;
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText((probPhishing * 100).toFixed(1) + '%', centerX, centerY - 10);

          // Label
          ctx.font = '14px sans-serif';
          ctx.fillStyle = '#64748b';
          ctx.fillText(predLabel.toUpperCase(), centerX, centerY + 20);

          ctx.restore();
        }
      }]
    });
  }

  {% if feature_preview %}
  // 2. Bar Chart untuk Full Features
  const featuresCtx = document.getElementById('featuresChart');
  if (featuresCtx) {
    const featureData = {
      labels: [
        {% for k, v in feature_preview %}'{{ k }}'{{ ', ' if not loop.last else '' }}{% endfor %}
      ],
      datasets: [{
        label: 'Nilai Fitur',
        data: [
          {% for k, v in feature_preview %}
            {% if v is number %}{{ v }}{% else %}0{% endif %}{{ ', ' if not loop.last else '' }}
          {% endfor %}
        ],
        backgroundColor: 'rgba(99, 102, 241, 0.7)',
        borderColor: 'rgba(99, 102, 241, 1)',
        borderWidth: 2,
        borderRadius: 6,
      }]
    };

    new Chart(featuresCtx, {
      type: 'bar',
      data: featureData,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: function(context) {
                return 'Value: ' + context.parsed.y.toFixed(4);
              }
            }
          }
        },
        scales: {
          x: {
            ticks: {
              font: { size: 10 },
              maxRotation: 45,
              minRotation: 45
            },
            grid: { display: false }
          },
          y: {
            beginAtZero: true,
            grid: {
              color: 'rgba(0, 0, 0, 0.05)'
            }
          }
        }
      }
    });
  }
  {% endif %}

  {% if urlonly_preview %}
  // 3. Bar Chart untuk URL-only Features
  const urlFeaturesCtx = document.getElementById('urlFeaturesChart');
  if (urlFeaturesCtx) {
    const urlFeatureData = {
      labels: [
        {% for k, v in urlonly_preview %}'{{ k }}'{{ ', ' if not loop.last else '' }}{% endfor %}
      ],
      datasets: [{
        label: 'Nilai Fitur URL',
        data: [
          {% for k, v in urlonly_preview %}
            {% if v is number %}{{ v }}{% else %}0{% endif %}{{ ', ' if not loop.last else '' }}
          {% endfor %}
        ],
        backgroundColor: 'rgba(168, 85, 247, 0.7)',
        borderColor: 'rgba(168, 85, 247, 1)',
        borderWidth: 2,
        borderRadius: 6,
      }]
    };

    new Chart(urlFeaturesCtx, {
      type: 'bar',
      data: urlFeatureData,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: function(context) {
                return 'Value: ' + context.parsed.y.toFixed(4);
              }
            }
          }
        },
        scales: {
          x: {
            ticks: {
              font: { size: 10 },
              maxRotation: 45,
              minRotation: 45
            },
            grid: { display: false }
          },
          y: {
            beginAtZero: true,
            grid: {
              color: 'rgba(0, 0, 0, 0.05)'
            }
          }
        }
      }
    });
  }
  {% endif %}
</script>

{% endblock %}
